<!doctype html>
<html lang="cn" dir="ltr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<meta name="generator" content="Docusaurus v2.0.0-alpha.72">
<link rel="alternate" type="application/rss+xml" href="/cn/blog/rss.xml" title="Xin Xiong Blog RSS Feed">
<link rel="alternate" type="application/atom+xml" href="/cn/blog/atom.xml" title="Xin Xiong Blog Atom Feed">
<link rel="search" type="application/opensearchdescription+xml" title="Xin Xiong" href="/cn/opensearch.xml"><title data-react-helmet="true">node_modules, the Heaviest Object in the Universe | Xin Xiong</title><meta data-react-helmet="true" property="og:title" content="node_modules, the Heaviest Object in the Universe | Xin Xiong"><meta data-react-helmet="true" name="description" content="相信大家在开发中都遇到过这样的问题：同一个项目，在本地开发环境没问题，到线上环境却有问题？那很可能是包管理出了问题。"><meta data-react-helmet="true" property="og:description" content="相信大家在开发中都遇到过这样的问题：同一个项目，在本地开发环境没问题，到线上环境却有问题？那很可能是包管理出了问题。"><meta data-react-helmet="true" property="og:url" content="https://leonaxiongxin.github.io/cn/blog/2020/06/04/node_modules-the-heaviest-object-in-the-universe"><meta data-react-helmet="true" name="docsearch:language" content="cn"><meta data-react-helmet="true" name="docsearch:docusaurus_tag" content="default"><link data-react-helmet="true" rel="shortcut icon" href="/cn/img/favicon.ico"><link data-react-helmet="true" rel="canonical" href="https://leonaxiongxin.github.io/cn/blog/2020/06/04/node_modules-the-heaviest-object-in-the-universe"><link data-react-helmet="true" rel="alternate" href="https://leonaxiongxin.github.io/cn/blog/2020/06/04/node_modules-the-heaviest-object-in-the-universe" hreflang="cn"><link data-react-helmet="true" rel="alternate" href="https://leonaxiongxin.github.io/blog/2020/06/04/node_modules-the-heaviest-object-in-the-universe" hreflang="en"><link data-react-helmet="true" rel="alternate" href="https://leonaxiongxin.github.io/blog/2020/06/04/node_modules-the-heaviest-object-in-the-universe" hreflang="x-default"><link data-react-helmet="true" rel="preconnect" href="https://BH4D9OD16A-dsn.algolia.net" crossorigin="anonymous"><link rel="stylesheet" href="/cn/assets/css/styles.e140522b.css">
<link rel="stylesheet" href="/cn/assets/css/main.5a36db70.css">
<link rel="stylesheet" href="/cn/assets/css/a6aa9e1f.d84a9ece.css">
<link rel="stylesheet" href="/cn/assets/css/ccc49370.d84a9ece.css">
<link rel="preload" href="/cn/assets/js/styles.77895f30.js" as="script">
<link rel="preload" href="/cn/assets/js/runtime~main.30c50a1a.js" as="script">
<link rel="preload" href="/cn/assets/js/main.8823eb63.js" as="script">
<link rel="preload" href="/cn/assets/js/1.9d1d04d3.js" as="script">
<link rel="preload" href="/cn/assets/js/2.628a5347.js" as="script">
<link rel="preload" href="/cn/assets/js/a6aa9e1f.16be7131.js" as="script">
<link rel="preload" href="/cn/assets/js/ccc49370.cf81b741.js" as="script">
<link rel="preload" href="/cn/assets/js/5cea1722.93a48cb0.js" as="script">
<link rel="preload" href="/cn/assets/js/10231cfb.f9b5f158.js" as="script">
</head>
<body>
<script>!function(){function t(t){document.documentElement.setAttribute("data-theme",t)}var e=function(){var t=null;try{t=localStorage.getItem("theme")}catch(t){}return t}();t(null!==e?e:"light")}()</script><div id="__docusaurus">
<div><a href="#main" class="skipToContent_1oUP">Skip to main content</a></div><nav class="navbar navbar--fixed-top"><div class="navbar__inner"><div class="navbar__items"><button aria-label="Navigation bar toggle" class="navbar__toggle" type="button" tabindex="0"><svg aria-label="Menu" width="30" height="30" viewBox="0 0 30 30" role="img" focusable="false"><title>Menu</title><path stroke="currentColor" stroke-linecap="round" stroke-miterlimit="10" stroke-width="2" d="M4 7h22M4 15h22M4 23h22"></path></svg></button><a class="navbar__brand" href="/cn/"><img src="/cn/img/logo.png" alt="My Site Logo" class="themedImage_1VuW themedImage--light_3UqQ navbar__logo"><img src="/cn/img/logo.png" alt="My Site Logo" class="themedImage_1VuW themedImage--dark_hz6m navbar__logo"></a><a aria-current="page" class="navbar__item navbar__link navbar__link--active" href="/cn/blog">Blog</a><a class="navbar__item navbar__link" href="/cn/archive">Archive</a><a class="navbar__item navbar__link" href="/cn/about">About</a><a href="https://github.com/leonaxiongxin/leonaxiongxin.github.io" target="_blank" rel="noopener noreferrer" class="navbar__item navbar__link">GitHub</a></div><div class="navbar__items navbar__items--right"><div class="react-toggle react-toggle--disabled displayOnlyInLargeViewport_GrZ2"><div class="react-toggle-track"><div class="react-toggle-track-check"><span class="toggle_71bT">🌜</span></div><div class="react-toggle-track-x"><span class="toggle_71bT">🌞</span></div></div><div class="react-toggle-thumb"></div><input type="checkbox" disabled="" aria-label="Dark mode toggle" class="react-toggle-screenreader-only"></div><button type="button" class="DocSearch DocSearch-Button" aria-label="Search"><span class="DocSearch-Button-Container"><svg width="20" height="20" class="DocSearch-Search-Icon" viewBox="0 0 20 20"><path d="M14.386 14.386l4.0877 4.0877-4.0877-4.0877c-2.9418 2.9419-7.7115 2.9419-10.6533 0-2.9419-2.9418-2.9419-7.7115 0-10.6533 2.9418-2.9419 7.7115-2.9419 10.6533 0 2.9419 2.9418 2.9419 7.7115 0 10.6533z" stroke="currentColor" fill="none" fill-rule="evenodd" stroke-linecap="round" stroke-linejoin="round"></path></svg><span class="DocSearch-Button-Placeholder">Search</span></span></button></div></div><div role="presentation" class="navbar-sidebar__backdrop"></div><div class="navbar-sidebar"><div class="navbar-sidebar__brand"><a class="navbar__brand" href="/cn/"><img src="/cn/img/logo.png" alt="My Site Logo" class="themedImage_1VuW themedImage--light_3UqQ navbar__logo"><img src="/cn/img/logo.png" alt="My Site Logo" class="themedImage_1VuW themedImage--dark_hz6m navbar__logo"></a></div><div class="navbar-sidebar__items"><div class="menu"><ul class="menu__list"><li class="menu__list-item"><a aria-current="page" class="menu__link navbar__link--active" href="/cn/blog">Blog</a></li><li class="menu__list-item"><a class="menu__link" href="/cn/archive">Archive</a></li><li class="menu__list-item"><a class="menu__link" href="/cn/about">About</a></li><li class="menu__list-item"><a href="https://github.com/leonaxiongxin/leonaxiongxin.github.io" target="_blank" rel="noopener noreferrer" class="menu__link">GitHub</a></li></ul></div></div></div></nav><div class="main-wrapper blog-wrapper"><div class="container margin-vert--lg"><div class="row"><main class="col col--9"><article><header><h1 class="margin-bottom--sm blogPostTitle_2U-J">node_modules, the Heaviest Object in the Universe</h1><div class="margin-vert--sm"><time datetime="2020-06-04T00:00:00.000Z" class="blogPostDate_n0XG">2020 M06 4 · One min read</time></div><div class="avatar margin-vert--sm"><div class="avatar__intro"></div></div></header><div class="markdown"><p>相信大家在开发中都遇到过这样的问题：同一个项目，在本地开发环境没问题，到线上环境却有问题？那很可能是包管理出了问题。</p><p>前端的项目依赖主要是通过 package.json 和 node_modules 管理，常见的包管理工具有 npm, yarn。</p><p>通常来说：npm 包 = 结构化模块 + 描述文件（package.json）</p><blockquote><p>需要注意的是：一个 module 不一定是一个 package，一个 package 也不一定是一个 module，package 可以是一个 tar 包，也可以是本地 file 协议，甚至是 git 仓库地址。</p></blockquote><p>在下文中，node_modules 的包管理主要分两个阶段说明：早期的 npm V2 阶段、 npm V3 及以后阶段。</p><h2><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_2LWZ" id="packagejson"></a>package.json<a class="hash-link" href="#packagejson" title="Direct link to heading">#</a></h2><p>package.json 主要用来定义项目的基础信息、相关执行命令及依赖包。</p><h3><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_2LWZ" id="dependencies"></a>*dependencies<a class="hash-link" href="#dependencies" title="Direct link to heading">#</a></h3><p>项目的依赖包可以划分为：</p><ul><li><p>dependencies</p><p>项目线上运行所依赖的包</p></li><li><p>devDependencies</p><p>项目开发过程中所需要的包，但是线上运行完全不需要，比如构建工具、CSS处理器、JS处理器、校验工具、测试工具的相关包。</p></li><li><p>peerDependencies</p><p>同伴依赖，常见于插件库依赖的核心库，避免核心库被重复下载的问题。</p><p>同伴依赖告知宿主环境需要的依赖以及版本范围，比如包 <code>react-native-safe-area-view</code> 的运行需要 <code>react</code> 和 <code>react-native</code> 库，就可以在 peerDependencies 里声明。</p><p>在 npm V2 阶段，依赖树采取 nest 嵌套模式（下文会说明），在安装 <code>react-native-safe-area-view</code> 时会顺便把它的 peerDependencies 也一起安装了。</p><p>在 npm V3 及以后阶段，依赖树采取 flat 扁平模式（下文会说明），peerDependencies 的处理相应有所变化。如果宿主环境没有对应版本范围内的依赖，在安装依赖时会报出警告，不会自动安装，需要手动安装，可以通过第三方库实现自动安装。</p></li><li><p>optionalDependencies</p><p>可选依赖，这种依赖即便安装失败，也不会中断依赖安装过程，会认为安装是成功的。</p></li><li><p>bundledDependencies</p><p>打包依赖，这个数组里的包都会被打包到最终的发布包里。</p><p>功能跟 dependencies 是一样的，区别在于，当需要构建项目并发布版本时，bundleDependencies 下的依赖会被包含在构建结果中，不需要另行安装了，通常用于不在 npm 发布的第三方包。</p><p>bundledDependencies 中的包必须是在其他 *dependencies 声明过的。</p></li></ul><h3><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_2LWZ" id="npm-semver"></a>npm-semver<a class="hash-link" href="#npm-semver" title="Direct link to heading">#</a></h3><p>npm 采用了<a href="https://docs.npmjs.com/misc/semver" target="_blank" rel="noopener noreferrer">语义化版本号</a>，在 package.json 文件中，我们常常会看到形如 “x.y.z” 的版本号，x、y、z的含义分别为主版本号、次版本号、补丁版本号。</p><ul><li>主版本号：大改动，新版本不兼容老版本的 API（主版本号为 0 通常表示是内测版本）。</li><li>次版本号：新增了部分功能，新版本<strong>应该</strong>向下兼容。</li><li>补丁版本号：修复了部分bug，新版本<strong>应该</strong>向下兼容。</li></ul><p>有时语义版本也会包含一些“标签”或者“扩展”，用于标记预发布版本或者测试版本，比如 2.0.0-beta.3。</p><p>在描述文件里，有时候我们也会看到带符号的版本号 &quot;5.0.3&quot;, &quot;~5.0.3&quot;, &quot;^5.0.3&quot;。</p><ul><li>&quot;5.0.3&quot; 表示安装指定的5.0.3版本。</li><li>字符 X、x 或者 * 都可以作为通配符，用于填充部分或全部版本号。</li><li>字符 ~，同时使用字符 ~ 和次版本号表明允许补丁版本号变更，同时使用字符 ~ 和主版本号表明允许次版本号变更。“~5.0.3”表示安装5.0.X中最新的版本。</li><li>字符 ^， 表明不会修改版本号中的第一个非零数字，“^5.0.3”表示安装 5.X.X 中最新的版本。</li></ul><p>不规范的版本号会导致同一个项目在不同时间、不同设备环境下无法保持一致性，可能会产生意想不到的 <strong>bug</strong> 。</p><p>最简单粗暴的方法是写死所有版本号，无视更新，但是这样跟不上外界的技术发展不利于项目更新。而且，大多数npm包都严重依赖于其他npm包，这就会导致嵌套依赖关系，并增加匹配相应版本的难度。为了解决这个问题，yarn 采用了锁文件 yarn.lock 来记录了被确切安装上的模块的版本号，npm &gt;= 5.0 也引入了类似的锁文件 package-lock.json。</p><p>实际上，package-lock.json 文件只是提供回溯记录，安装时参照的还是 package.json 里的版本号，一个 🌰：</p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly text"><div tabindex="0" class="prism-code language-text codeBlock_23N8 thin-scrollbar"><div class="codeBlockLines_39YC" style="color:#bfc7d5;background-color:#292d3e"><div class="token-line" style="color:#bfc7d5"><span class="token plain">假设半年前项目依赖的vue版本是2.5.13，现在 vue 更新到 2.5.21 版本， 并且 package.json 中 vue: &#x27;^2.5.2&#x27;。</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">如果项目使用的包管理工具是 yarn，yarn.lock 文件中的 vue 依赖为2.5.13，</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">现在重新执行 yarn，node_modules 中 vue 的依赖还是 2.5.13，并没有被更新到 2.5.21。</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">如果项目使用的包管理工具是 npm，项目中的 package-lock.json 中的 vue 依赖为2.5.13，</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">现在执行 npm install，node_modules 中的 vue 依赖自动更新成 2.5.21，package-lock.json 中的 vue 版本不变，这就导致不同时期安装的依赖的版本不同。</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">解决方法：查看 package-lock.json 中的 vue 版本，例如是 2.5.13，将 package.json 中的依赖直接写成固定版本，&quot;vue&quot;: &quot;2.5.13&quot;， 或者 npm install 后执行 npm install vue@2.5.13。</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o">Copy</button></div></div><blockquote><p>yarn 还提供了 resolutions 机制，可以强行用指定版本去覆盖。</p></blockquote><p>然而还是有一些场景lock文件无法覆盖，当我们第一次安装创建项目时或者第一次安装某个依赖的时候，此时即使第三方库里含有 lock 文件，但是并不会去读取第三方依赖的lock，这导致第一次创建项目的时候还是可能会触发bug。</p><h2><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_2LWZ" id="node_modules"></a>node_modules<a class="hash-link" href="#node_modules" title="Direct link to heading">#</a></h2><p>Node 的作者对于 node 的遗憾之一就是支持了 node_modules。事实上，除了 Node 的 npm，很少有其他语言是需要每个项目都维护一个 node_modules。</p><p>node_modules 的模块寻址策略是：</p><ul><li><p>核心模块</p><p>已内置，可以直接引用（比如 fs ），优先级仅次于缓存加载。</p></li><li><p>路径形式的文件模块</p><p>把路径转换为真实路径，初次编译执行后将结果放在缓存内。</p></li><li><p>自定义（第三方）模块</p><p>先找当前目录下的 node_modules，没有的话再找上一级目录的 node_modules，向上逐级递归直到系统用户根目录下的 node_modules。即优先读取最近的 node_modules 的依赖，递归向上查找。</p></li></ul><p>这样的设计听起来很合理，相互之间的依赖调用完全隔离，允许多版本兼容，简直完美。但是，实际上存在不少问题。例如，项目 App 引入的第三方包 A 和 C，A 自身引入了 B v1.0，C 自身引入了 B v2.0，项目自身没有显示依赖模块 B，那么到底是安装 B v1.0 还是 B v2.0 ？</p><p><img alt="项目依赖 A、C" src="data:image/png;base64,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">
<img alt="A、C 依赖 B" src="/cn/assets/images/npm-1-5031b278f1ca7d95788e590c05be9e6e.png">
<img alt="如何确定 B 的版本" src="/cn/assets/images/npm-2-4d05a9ecb47cc9df7b3826dbe981dbd8.png"></p><p>如果 B 本身不支持多版本共存（会产生全局污染的副作用），那么需要尽早在包安装阶段就报错检查。</p><p>如果 B 本身支持多版本共存，那么我们需要通过一定的方法保证模块之间的正确加载顺序，但是多版本共存很容易出现 <strong>Dependency Hell</strong> 的问题。</p><h3><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_2LWZ" id="npm-v2：nest-mode-嵌套结构"></a>npm V2：nest mode 嵌套结构<a class="hash-link" href="#npm-v2：nest-mode-嵌套结构" title="Direct link to heading">#</a></h3><p>在 npm V2 阶段，根据模块寻址策略，对于第三方包，递归向上查找 node_modules 依赖，按照 package.json 结构以及子依赖包的 package.json 结构将依赖安装到他们各自的 node_modules 中，直到有子依赖包不再依赖其他模块。</p><p><img alt="nest mode" src="/cn/assets/images/npm-3-fe119c99524d304b76e9adc4cc99e487.png"></p><p>显然，这样会造成重复依赖的问题，如果我们有 100 个依赖包，其中有 90 个包依赖了 lodash 包，那么项目会安装90个 lodash 。重复依赖不仅仅会造成空间浪费，拉包耗时，有时候也会产生全局types 冲突，破坏单例模式，甚至导致项目无法正常运行。</p><p><img alt="the heaviest object in the universe" src="/cn/assets/images/npm-4-91c9913797e24498a217437b6bd32202.png"></p><h3><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_2LWZ" id="npm-v3-及之后：-flat-mode-扁平结构"></a>npm V3 及之后： flat mode 扁平结构<a class="hash-link" href="#npm-v3-及之后：-flat-mode-扁平结构" title="Direct link to heading">#</a></h3><p>在 npm V3 及之后阶段，同样利用向上递归查找依赖的特性，不同的是，把一些公共依赖放在项目根目录公共的 node_module 里，相比较 nest mode，节省了空间。</p><p><img alt="flat mode" src="/cn/assets/images/npm-5-21a439e2398c11fa2675da2d2190582d.png"></p><p>然而，树形结构不稳定，很大程度上会受到依赖安装顺序的影响，如果新引入的 E 依赖的是 B v1.0，而 C 和 D 依赖的是 B v2.0，那么无论是把 B v1.0 还是 B v2.0 放在公共的 node_module 里，仍然无法完全避免重复依赖的问题。</p><p><img alt="problem of flat mode" src="/cn/assets/images/npm-6-bb939aba819f51109d1ff6dd15d1754e.png"></p><p>而且，幽灵依赖（<strong>Phantom dependency</strong>）也是很容易被忽视的问题，例如 A 可以轻松地导入 C，即使在 A 里没有声明 C 为其依赖，A 也可以轻松地导入 C 的第三方依赖，如果有朝一日 C 的第三方依赖发生变更，就可能会影响到 A。</p><h3><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_2LWZ" id="dependency-graph"></a>Dependency graph<a class="hash-link" href="#dependency-graph" title="Direct link to heading">#</a></h3><p>在不考虑循环依赖情况的前提下，项目内模块的依赖关系应该是一个有向无环图，是典型的拓扑结构，npm 和 yarn 通过文件目录和路径解析算法模拟的只是有向无环图的一个超集（多了很多错误的祖先节点和兄弟节点之间的链接），这就导致了很多的问题。</p><p>pnpm 通过硬链接（hard link）和符号链接（symlink），更加精确地模拟拓扑结构，来解决问题。</p><blockquote><p>软链接（符号链接）是一类特殊的可执行文件， 其包含有一条以绝对路径或者相对路径的形式指向其它文件或者目录的引用。</p></blockquote><p>pnpm 不仅能保证一个项目里的所有 package 的每个版本是唯一的，甚至能保证不同的项目之间也可以公用唯一的版本（只需要公用 store 即可），可以极大地节省空间。</p><p><img alt="pnpm" src="/cn/assets/images/pnpm-72dc599a650a7317c6d774cf420ebfca.jpg"></p><h2><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_2LWZ" id="npm-config-配置"></a>npm-config 配置<a class="hash-link" href="#npm-config-配置" title="Direct link to heading">#</a></h2><p>配置项的优先级：命令行 &gt; ENV 环境变量 &gt; .npmrc &gt; 系统默认配置。</p><p>当系统中存在多个 .npmrc 文件，这些配置文件的优先级从高到低的顺序为：</p><ol><li>项目级， /path/to/my/project/.npmrc</li><li>用户级， ~/.npmrc</li><li>全局级，$PREFIX/etc/npmrc</li><li>npm 内置，/path/to/npm/npmrc</li></ol><p>对于使用 yarn 的项目，.yarnrc （在 yarn 2.X 中是 .yarnrc.yml ）作为 .npmrc 的 扩展，.npmrc 的优先级更高，在 .npmrc 和 .yarnrc 同时存在于项目里，会参照 .npmrc 的 registry，在开发时需要注意。（<strong>经测试，低版本的 yarn 不会读取 .npmrc 的配置</strong>）</p><h2><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_2LWZ" id="deno-的包管理"></a>Deno 的包管理<a class="hash-link" href="#deno-的包管理" title="Direct link to heading">#</a></h2><p>总的来说，Node 的递归向上查找 node_modules 的算法，强依赖于 node_modules 的物理拓扑结构，这也是导致不同项目的项目难以复用 node_modules 的根源，目前的解决方案都只是在给这个问题打补丁。</p><p>Deno 1.0 目前的做法，直接通过 URL 来加载模块（初次下载后本地缓存），感觉上就像 script 标签。官方示例：</p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly js"><div tabindex="0" class="prism-code language-js codeBlock_23N8 thin-scrollbar"><div class="codeBlockLines_39YC" style="color:#bfc7d5;background-color:#292d3e"><div class="token-line" style="color:#bfc7d5"><span class="token keyword module" style="font-style:italic">import</span><span class="token plain"> </span><span class="token imports punctuation" style="color:rgb(199, 146, 234)">{</span><span class="token imports"> serve </span><span class="token imports punctuation" style="color:rgb(199, 146, 234)">}</span><span class="token plain"> </span><span class="token keyword module" style="font-style:italic">from</span><span class="token plain"> </span><span class="token string" style="color:rgb(195, 232, 141)">&quot;https://deno.land/std@0.50.0/http/server.ts&quot;</span><span class="token punctuation" style="color:rgb(199, 146, 234)">;</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain"></span><span class="token keyword" style="font-style:italic">const</span><span class="token plain"> s </span><span class="token operator" style="color:rgb(137, 221, 255)">=</span><span class="token plain"> </span><span class="token function" style="color:rgb(130, 170, 255)">serve</span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token punctuation" style="color:rgb(199, 146, 234)">{</span><span class="token plain"> port</span><span class="token operator" style="color:rgb(137, 221, 255)">:</span><span class="token plain"> </span><span class="token number" style="color:rgb(247, 140, 108)">8000</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(199, 146, 234)">}</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token punctuation" style="color:rgb(199, 146, 234)">;</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain"></span><span class="token keyword control-flow" style="font-style:italic">for</span><span class="token plain"> </span><span class="token keyword control-flow" style="font-style:italic">await</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token keyword" style="font-style:italic">const</span><span class="token plain"> req </span><span class="token keyword" style="font-style:italic">of</span><span class="token plain"> s</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(199, 146, 234)">{</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  req</span><span class="token punctuation" style="color:rgb(199, 146, 234)">.</span><span class="token method function property-access" style="color:rgb(130, 170, 255)">respond</span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token punctuation" style="color:rgb(199, 146, 234)">{</span><span class="token plain"> body</span><span class="token operator" style="color:rgb(137, 221, 255)">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(195, 232, 141)">&quot;Hello World\n&quot;</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(199, 146, 234)">}</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token punctuation" style="color:rgb(199, 146, 234)">;</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain"></span><span class="token punctuation" style="color:rgb(199, 146, 234)">}</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o">Copy</button></div></div><p>Deno 只支持 ES6 的模块规范，不支持 CommonJS 模块规范，不提供 require 命令。</p><p>Deno 没有 npm，没有中心化的 npm registry，也没有 package.json 和 node_modules。官方的说法是：</p><blockquote><p>These modules do not have external dependencies and they are reviewed by the Deno core team. The intention is to have a standard set of high quality code that all Deno projects can use fearlessly.
即：所有模块没有外部依赖性，并且（官方包）由Deno核心团队进行审查。目的是提供一套标准的高质量代码，所有Deno项目都可以无依赖的使用它们。</p></blockquote><p>目前，Deno 官方库差不多有 <a href="https://deno.land/std/" target="_blank" rel="noopener noreferrer">25个一级目录（约1600个文件）</a> 可供使用 ，第三方模块约有 <a href="https://deno.land/x/" target="_blank" rel="noopener noreferrer">233个</a>。</p></div><footer class="row margin-vert--md"><div class="col"><svg class="icon_11fs" viewBox="0 0 1024 1024" xmlns="http://www.w3.org/2000/svg" width="16" height="16"><title>tags</title><defs><style></style></defs><path d="M995.127 635.047l-360.08 360.08a53.333 53.333 0 01-71.333 3.68l356.22-356.22a64 64 0 000-90.507L495.84 128h45.574a52.987 52.987 0 0137.713 15.62l416 416a53.4 53.4 0 010 75.427zm-128-75.427l-416-416A52.987 52.987 0 00413.414 128h-74.567a361.707 361.707 0 012.487 42.667c0 42.713-7.267 83.2-20.474 114-5.146 12-10.746 21.546-16.48 29.08a85.287 85.287 0 11-48.38-15.08c6 0 16.574-9.64 25.647-30.807 10.813-25.24 17.02-60.667 17.02-97.193A314.76 314.76 0 00295.794 128h-79.587c2.82-20.533 7.653-39.367 14.147-54.527C239.427 52.307 250 42.667 256 42.667s16.574 9.64 25.647 30.806c6.493 15.16 11.333 34 14.147 54.527h43.053c-3.167-26.56-9.287-51.047-18-71.333C299.734 7.333 271.154 0 256 0s-43.733 7.333-64.86 56.667c-8.666 20.286-14.82 44.773-18 71.333H53.334A53.393 53.393 0 000 181.333v360.08a52.987 52.987 0 0015.62 37.714l416 416a53.333 53.333 0 0075.427 0l360.08-360.08a53.4 53.4 0 000-75.427z" fill="#789262"></path></svg><a class="margin-horiz--sm" href="/cn/blog/tags/fe">FE</a><a class="margin-horiz--sm" href="/cn/blog/tags/node">Node</a><a class="margin-horiz--sm" href="/cn/blog/tags/engineering">Engineering</a></div></footer></article><div></div><div class="margin-vert--xl"><nav class="pagination-nav" aria-label="Blog post page navigation"><div class="pagination-nav__item"><a class="pagination-nav__link" href="/cn/blog/2020/06/07/What-does-FE-CLI-do"><div class="pagination-nav__sublabel">Newer Post</div><div class="pagination-nav__label">« 前端项目脚手架做了什么？</div></a></div><div class="pagination-nav__item pagination-nav__item--next"><a class="pagination-nav__link" href="/cn/blog/2020/05/25/How-to-IO-Using-Node"><div class="pagination-nav__sublabel">Older Post</div><div class="pagination-nav__label">How to IO Using Node »</div></a></div></nav></div></main><div class="col col--3"><div class="tableOfContents_35-E thin-scrollbar"><ul class="table-of-contents table-of-contents__left-border"><li><a href="#packagejson" class="table-of-contents__link">package.json</a><ul><li><a href="#dependencies" class="table-of-contents__link">*dependencies</a></li><li><a href="#npm-semver" class="table-of-contents__link">npm-semver</a></li></ul></li><li><a href="#node_modules" class="table-of-contents__link">node_modules</a><ul><li><a href="#npm-v2：nest-mode-嵌套结构" class="table-of-contents__link">npm V2：nest mode 嵌套结构</a></li><li><a href="#npm-v3-及之后：-flat-mode-扁平结构" class="table-of-contents__link">npm V3 及之后： flat mode 扁平结构</a></li><li><a href="#dependency-graph" class="table-of-contents__link">Dependency graph</a></li></ul></li><li><a href="#npm-config-配置" class="table-of-contents__link">npm-config 配置</a></li><li><a href="#deno-的包管理" class="table-of-contents__link">Deno 的包管理</a></li></ul></div></div></div></div></div><footer class="footer"><div class="row"><div class="col col--3 footerLeft_37Uk"><div class="col"><ul class="footer__items footerItems_1Qot"><li class="footer__item footerItemLink_2bF2"><a href="https://www.zhihu.com/people/xiong-xin-64-58" target="_blank" rel="noopener noreferrer" class="footer__link-item"><svg class="icon_24ss" viewBox="0 0 1024 1024" xmlns="http://www.w3.org/2000/svg" width="16" height="16"><title>知乎</title><defs><style></style></defs><path d="M512 73.28A438.72 438.72 0 10950.72 512 438.72 438.72 0 00512 73.28zm-98.56 458.88l-16.8 66.88 23.68-20.8s53.92 61.28 64 76.48 1.44 68.96 1.44 68.96l-92.48-113.12s-29.12 101.12-68.48 124.16a97.6 97.6 0 01-80 6.56 342.08 342.08 0 0085.44-89.76 382.88 382.88 0 0039.52-119.36H254.72s8.8-40.48 24.16-41.6 90.88 0 90.88 0L368 365.76 324.8 368a96 96 0 01-32 48c-24.16 17.44-38.4 10.88-38.4 10.88s42.72-118.24 55.84-141.28 50.4-25.12 50.4-25.12L337.6 327.2h147.84c17.6 0 18.56 40.64 18.56 40.64h-90.56V490.4s61.28-2.24 81.12 0 19.68 41.6 19.68 41.6zm329.44 160h-91.52l-65.12 46.24-13.6-46.24h-36.96v-368h208z" fill="#49C0FB"></path><path d="M602.88 691.68l54.88-41.44h43.04v-285.6H579.68v285.6h11.2l12 41.44z" fill="#49C0FB"></path></svg></a></li><li class="footer__item footerItemLink_2bF2"><a href="https://www.douban.com/people/157300719/" target="_blank" rel="noopener noreferrer" class="footer__link-item"><svg class="icon_24ss" viewBox="0 0 1024 1024" xmlns="http://www.w3.org/2000/svg" width="16" height="16"><title>豆瓣</title><defs><style></style></defs><path d="M411.52 574.72A969.92 969.92 0 01471.36 692h83.36a668.16 668.16 0 0060.8-117.28z" fill="#61CD72"></path><path d="M512 73.28A438.72 438.72 0 10950.72 512 438.72 438.72 0 00512 73.28zm-215.36 228.8h434.88v44.16H296.64zM741.6 736H283.52v-44h136.96A612.8 612.8 0 00368 597.44l35.2-22.72h-62.4v-176h348v176H624l35.36 23.2A633.12 633.12 0 01608 692h134.24z" fill="#61CD72"></path><path d="M389.44 443.68H640v86.56H389.44z" fill="#61CD72"></path></svg></a></li><li class="footer__item footerItemLink_2bF2"><a href="https://github.com/leonaxiongxin" target="_blank" rel="noopener noreferrer" class="footer__link-item"><svg class="icon_24ss" viewBox="0 0 1024 1024" xmlns="http://www.w3.org/2000/svg" width="16" height="16"><title>Github</title><defs><style></style></defs><path d="M511.968 73.152q119.424 0 220.288 58.848t159.712 159.712T950.816 512q0 143.424-83.712 258.016t-216.288 158.56q-15.424 2.848-22.848-4t-7.424-17.152q0-1.728.288-43.712t.288-76.864q0-55.424-29.728-81.152 32.576-3.424 58.56-10.272t53.728-22.272 46.272-38.016 30.272-60 11.712-86.016q0-68-45.152-117.728 21.152-52-4.576-116.576-16-5.152-46.272 6.272T643.36 286.24l-21.728 13.728Q568.48 285.12 511.904 285.12t-109.728 14.848q-9.152-6.272-24.288-15.424t-47.712-22.016-48.576-7.712q-25.728 64.576-4.576 116.576-45.152 49.728-45.152 117.728 0 48.576 11.712 85.728t30.016 60 46.016 38.272 53.728 22.272 58.56 10.272q-22.272 20.576-28 58.848-12 5.728-25.728 8.576t-32.576 2.848-37.44-12.288-31.712-35.712q-10.848-18.272-27.712-29.728t-28.288-13.728l-11.424-1.728q-12 0-16.576 2.56t-2.848 6.56 5.152 8 7.424 6.848l4 2.848q12.576 5.728 24.864 21.728t18.016 29.152l5.728 13.152q7.424 21.728 25.152 35.136t38.272 17.152 39.712 4 31.712-2.016l13.152-2.272q0 21.728.288 50.56t.288 31.136q0 10.272-7.424 17.152t-22.848 4q-132.576-44-216.288-158.56T73.088 511.872q0-119.424 58.848-220.288t159.712-159.712 220.288-58.848zM239.392 703.424q1.728-4-4-6.848-5.728-1.728-7.424 1.152-1.728 4 4 6.848 5.152 3.424 7.424-1.152zm17.728 19.424q4-2.848-1.152-9.152-5.728-5.152-9.152-1.728-4 2.848 1.152 9.152 5.728 5.728 9.152 1.728zm17.152 25.728q5.152-4 0-10.848-4.576-7.424-9.728-3.424-5.152 2.848 0 10.272t9.728 4zm24 24Q302.848 768 296 761.728q-6.848-6.848-11.424-1.728-5.152 4.576 2.272 10.848 6.848 6.848 11.424 1.728zm32.576 14.272q1.728-6.272-7.424-9.152-8.576-2.272-10.848 4t7.424 8.576q8.576 3.424 10.848-3.424zm36 2.88q0-7.424-9.728-6.272-9.152 0-9.152 6.272 0 7.424 9.728 6.272 9.152 0 9.152-6.272zm33.12-5.728q-1.152-6.272-10.272-5.152-9.152 1.728-8 8.576T391.968 792t8-8z"></path></svg></a></li><li class="footer__item footerItemLink_2bF2"><a href="https://www.linkedin.com/in/xinxiong96" target="_blank" rel="noopener noreferrer" class="footer__link-item"><svg class="icon_24ss" viewBox="0 0 1024 1024" xmlns="http://www.w3.org/2000/svg" width="16" height="16"><title>Linkedin</title><defs><style></style></defs><path d="M0 512C0 229.227 229.227 0 512 0s512 229.227 512 512-229.227 512-512 512S0 794.773 0 512z" fill="#0077B5"></path><path d="M369.472 316.224c0 33.472-25.195 60.245-65.664 60.245h-.747c-38.954 0-64.128-26.773-64.128-60.245 0-34.197 25.942-60.224 65.643-60.224s64.128 26.027 64.896 60.224zm-7.637 107.84v348.63H245.803v-348.63h116.032zm418.432 348.63V572.8c0-107.093-57.238-156.928-133.59-156.928-61.61 0-89.173 33.835-104.576 57.579v-49.387H426.048c1.536 32.725 0 348.63 0 348.63h116.053v-194.71c0-10.41.747-20.8 3.819-28.267 8.384-20.821 27.477-42.368 59.541-42.368 41.984 0 58.774 31.979 58.774 78.827v186.517h116.032z" fill="#FFF"></path></svg></a></li></ul></div></div><div class="col col--9 footer__bottom text--center footerRight_oIT5"><div class="footerCopyright_Jlwn">Copyright © 2018-2021 Xin Xiong. Built with <a href="https://docusaurus.io/">Docusaurus</a> and 💙.</div></div></div></footer></div>
<script src="/cn/assets/js/styles.77895f30.js"></script>
<script src="/cn/assets/js/runtime~main.30c50a1a.js"></script>
<script src="/cn/assets/js/main.8823eb63.js"></script>
<script src="/cn/assets/js/1.9d1d04d3.js"></script>
<script src="/cn/assets/js/2.628a5347.js"></script>
<script src="/cn/assets/js/a6aa9e1f.16be7131.js"></script>
<script src="/cn/assets/js/ccc49370.cf81b741.js"></script>
<script src="/cn/assets/js/5cea1722.93a48cb0.js"></script>
<script src="/cn/assets/js/10231cfb.f9b5f158.js"></script>
</body>
</html>